{% load static %}

<div class="modal fade" id="createWatchlistModal" tabindex="-1" aria-labelledby="createWatchlistModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createWatchlistModalLabel">Create New Watchlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createWatchlistForm" method="post" action="{% url 'dashboard:create_watchlist' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="watchlistName" class="form-label">Watchlist Name</label>
                        <input type="text" class="form-control" id="watchlistName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="watchlistDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="watchlistDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="stockSelection" class="form-label">Select Stocks</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="stockSearch" placeholder="Search stocks by name or symbol...">
                            <button class="btn btn-primary" type="button" id="addStock">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div class="stock-list-container" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 10px;">
                            <div class="list-group">
                                {% for stock in stocks %}
                                <div class="list-group-item stock-item" style="background: transparent; border: none; padding: 8px; cursor: pointer;" tabindex="0">
                                    <div class="form-check">
                                        <input class="form-check-input stock-checkbox" type="checkbox" value="{{ stock.id }}" id="stock{{ stock.id }}" name="stocks">
                                        <label class="form-check-label" for="stock{{ stock.id }}">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ stock.symbol }}</strong>
                                                    <small class="text-muted d-block">{{ stock.name }}</small>
                                                </div>
                                                <span class="badge bg-secondary">{{ stock.sector }}</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div id="noResults" class="text-center text-muted py-3" style="display: none;">
                                No stocks found matching your search.
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Selected stocks: <span id="selectedCount">0</span></small>
                        </div>
                        <div id="selectedStocksList" class="mt-2 d-flex flex-wrap gap-2">
                            <!-- Selected stocks will be shown here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createWatchlist()">Create Watchlist</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DEBUG: Create watchlist modal initialized');
    
    // Stock search functionality
    const stockItems = document.querySelectorAll('.stock-item');
    console.log('DEBUG: Number of stock items found:', stockItems.length);
    console.log('DEBUG: First stock item:', stockItems[0]?.innerHTML);
    
    const stockListContainer = document.querySelector('.stock-list-container');
    const noResults = document.getElementById('noResults');
    const selectedStocksList = document.getElementById('selectedStocksList');
    const stockSearch = document.getElementById('stockSearch');
    const addStockBtn = document.getElementById('addStock');

    // Function to handle stock item click
    function handleStockItemClick(item) {
        console.log('DEBUG: Stock item clicked:', item.querySelector('strong').textContent);
        const checkbox = item.querySelector('.stock-checkbox');
        checkbox.checked = !checkbox.checked;
        const event = new Event('change');
        checkbox.dispatchEvent(event);
    }

    // Add click handlers to stock items
    stockItems.forEach(item => {
        item.addEventListener('click', function(e) {
            if (e.target !== this.querySelector('.stock-checkbox')) {
                handleStockItemClick(this);
            }
        });
    });

    // Add keyboard navigation
    stockSearch.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            e.preventDefault();
            const visibleItems = Array.from(stockItems).filter(item => item.style.display !== 'none');
            const currentIndex = visibleItems.findIndex(item => item === document.activeElement);
            let nextIndex;

            if (e.key === 'ArrowDown') {
                nextIndex = currentIndex < visibleItems.length - 1 ? currentIndex + 1 : 0;
            } else {
                nextIndex = currentIndex > 0 ? currentIndex - 1 : visibleItems.length - 1;
            }

            visibleItems[nextIndex].focus();
        } else if (e.key === 'Enter' && document.activeElement.classList.contains('stock-item')) {
            e.preventDefault();
            handleStockItemClick(document.activeElement);
        }
    });

    // Handle search input
    stockSearch.addEventListener('input', function(e) {
        const searchText = e.target.value.trim().toLowerCase();
        console.log('DEBUG: Search text:', searchText);
        
        let visibleCount = 0;
        
        stockItems.forEach(item => {
            const symbol = item.querySelector('strong').textContent.toLowerCase();
            const name = item.querySelector('small').textContent.toLowerCase();
            console.log('DEBUG: Checking stock:', { symbol, name, matches: symbol.includes(searchText) || name.includes(searchText) });
            
            if (symbol.includes(searchText) || name.includes(searchText)) {
                item.style.display = '';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        console.log('DEBUG: Visible items count:', visibleCount);
        
        // Show/hide no results message
        if (visibleCount === 0) {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
    });

    // Add stock button click handler
    addStockBtn.addEventListener('click', function() {
        const searchText = stockSearch.value.trim();
        console.log('DEBUG: Add button clicked, search text:', searchText);
        if (searchText.length > 0) {
            const visibleItems = Array.from(stockItems).filter(item => item.style.display !== 'none');
            console.log('DEBUG: Number of visible items:', visibleItems.length);
            if (visibleItems.length > 0) {
                // Select the first visible item
                handleStockItemClick(visibleItems[0]);
                // Clear the search input
                stockSearch.value = '';
            }
        }
    });

    // Update selected count and selected stocks list
    document.querySelectorAll('.stock-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const selectedCount = document.querySelectorAll('.stock-checkbox:checked').length;
            document.getElementById('selectedCount').textContent = selectedCount;
            
            // Update selected stocks list
            updateSelectedStocksList();
        });
    });

    // Function to update selected stocks list
    function updateSelectedStocksList() {
        selectedStocksList.innerHTML = '';
        document.querySelectorAll('.stock-checkbox:checked').forEach(checkbox => {
            const stockItem = checkbox.closest('.stock-item');
            const symbol = stockItem.querySelector('strong').textContent;
            const name = stockItem.querySelector('small').textContent;
            
            const stockTag = document.createElement('div');
            stockTag.className = 'badge bg-primary d-flex align-items-center gap-2';
            stockTag.innerHTML = `
                ${symbol}
                <button type="button" class="btn-close btn-close-white" onclick="removeStock('${checkbox.id}')"></button>
            `;
            selectedStocksList.appendChild(stockTag);
        });
    }

    // Function to remove a stock
    window.removeStock = function(checkboxId) {
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) {
            checkbox.checked = false;
            const event = new Event('change');
            checkbox.dispatchEvent(event);
        }
    };

    // Function to handle watchlist creation
    window.createWatchlist = function() {
        const form = document.getElementById('createWatchlistForm');
        const formData = new FormData(form);
        
        // Get all checked stock checkboxes
        const selectedStocks = Array.from(document.querySelectorAll('.stock-checkbox:checked')).map(cb => cb.value);
        formData.delete('stocks'); // Remove the original stocks field
        selectedStocks.forEach(stockId => formData.append('stocks', stockId));
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('createWatchlistModal'));
                modal.hide();
                
                // Reset form
                form.reset();
                document.querySelectorAll('.stock-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('selectedCount').textContent = '0';
                selectedStocksList.innerHTML = '';
                
                // Show success message
                showAlert('success', data.message);
                
                // Show warning if there were duplicate stocks
                if (data.warning) {
                    showAlert('warning', data.warning);
                }
                
                // Reload page to show new watchlist
                setTimeout(() => window.location.reload(), 1000);
            } else {
                // Handle form errors
                if (data.error) {
                    let errorMessage = '';
                    for (const field in data.error) {
                        errorMessage += `${field}: ${data.error[field].join(', ')}\n`;
                    }
                    showAlert('danger', errorMessage);
                } else {
                    showAlert('danger', 'Failed to create watchlist');
                }
            }
        })
        .catch(error => {
            showAlert('danger', 'An error occurred while creating the watchlist');
        });
    };

    // Function to show alerts
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert alert before the form
        const form = document.getElementById('createWatchlistForm');
        form.parentNode.insertBefore(alertDiv, form);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
});
</script> 